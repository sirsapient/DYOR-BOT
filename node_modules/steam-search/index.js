var request = require('request');
var cheerio = require('cheerio');

const SEARCH_URL = "http://store.steampowered.com/search/results?sort_by=_ASC&page=1&term=";

//Return info about the first search result
exports.getFirstGameInfo = function(query, callback){
  var url = SEARCH_URL + query;

  request(url, function(error, response, html){
    if(error) return error;

    var $ = cheerio.load(html);
    //var data = $(this);
    //console.log($("#search_result_container").find('div:not([class])').children());
    var results = $("#search_result_container").find('div:not([class])').children();

    if(results.length == 0){
      console.log("fail");
      return null;
    }else{
      var json = { title : "", release : "", price : "", image : "", appid : "", rating : ""};
      var firstResult = results[1];

      //console.log("tittle: " + firstResult);
      json.title = $(firstResult).find(".title").text();
      json.release = $(firstResult).find(".search_released").text();
      json.price = $(firstResult).find(".search_price").text().trim();
      json.image = $(firstResult).find("img").attr('src');
      json.appid = $(firstResult).data("ds-appid");
      json.rating = $(firstResult).find(".search_review_summary").data("store-tooltip");

      return callback(json);
    }
  });
}
